# ==============================================================================
# Curso de Estadística no paramétrica con R
# Canal de Youtube: Asesoría Estadística y Tesis
# Autor: Profesor Andre Chocó-Cedillos
# Tema 19: Métodos no paramétricos de respuesta múltiple
# ==============================================================================

# Carga de paquetes
library(dplyr)
library(MVN)
library(heplots)
library(car)
library(biotools)
library(npmv)
library(vegan)

# ==============================================================================
# 1. LECTURA DE DATOS
# =============================================================================

correlativo <- 1:480
muestra <- rep(1:40, times = 12)
repeticion <- rep(1:3, each = 40, times = 4)
estrato <- rep(1:12, each = 40)
tipo_de_tratamiento <- rep(1:4, each = 120)
peso_foliar <- c(
  1.8, 1.8, 1.6, 1.9, 1.8, 1.8, 1.8, 1.5, 1.6, 1.6, 1.6, 1.7, 1.6, 1.9, 1.5, 1.9, 1.8, 1.8, 2.0, 1.8, 
  2.1, 2.0, 1.8, 1.8, 1.6, 1.6, 1.5, 1.5, 1.6, 1.5, 1.9, 1.9, 1.8, 1.8, 1.9, 1.5, 2.0, 2.0, 1.9, 1.9, 
  2.1, 1.9, 1.5, 1.9, 2.1, 1.5, 2.1, 1.5, 1.8, 1.8, 1.7, 1.9, 2.3, 1.7, 1.8, 1.8, 1.8, 1.7, 1.7, 1.5, 
  1.5, 1.8, 1.6, 1.6, 1.7, 1.5, 1.5, 1.5, 1.7, 1.5, 1.8, 1.6, 1.6, 1.9, 1.7, 1.7, 1.6, 1.8, 1.7, 1.9, 
  1.5, 1.3, 1.7, 1.4, 1.9, 1.7, 1.6, 1.2, 1.3, 1.5, 1.9, 1.3, 1.5, 1.7, 1.8, 1.4, 1.5, 1.4, 1.7, 1.6, 
  1.6, 1.5, 1.6, 1.6, 1.9, 1.8, 1.8, 1.7, 1.7, 1.6, 1.4, 1.8, 1.4, 1.7, 1.4, 1.9, 1.5, 1.6, 1.5, 1.4, 
  1.4, 1.4, 1.5, 1.9, 1.7, 1.7, 1.7, 1.5, 1.4, 2.1, 1.7, 1.7, 1.8, 1.5, 1.6, 1.6, 1.9, 1.9, 1.3, 1.6, 
  1.5, 1.7, 1.4, 1.5, 1.3, 1.3, 1.3, 1.6, 1.5, 1.5, 1.5, 1.6, 1.5, 1.3, 1.3, 1.4, 1.6, 1.4, 1.5, 1.5, 
  1.7, 1.8, 1.8, 1.8, 2.3, 2.2, 2.2, 1.9, 2.3, 2.2, 2.2, 2.0, 2.2, 2.3, 1.9, 2.2, 1.8, 1.8, 2.2, 2.3, 
  2.3, 2.3, 2.1, 1.8, 2.3, 2.0, 2.3, 1.8, 1.8, 1.9, 2.3, 2.3, 2.0, 2.1, 2.1, 2.4, 2.2, 2.2, 2.0, 1.8, 
  2.1, 1.7, 2.1, 1.9, 1.9, 1.8, 1.9, 1.8, 1.8, 1.8, 1.9, 2.1, 2.0, 2.0, 2.2, 1.6, 1.9, 1.9, 2.0, 1.8, 
  2.0, 2.1, 1.8, 2.1, 1.6, 1.9, 2.0, 1.8, 1.9, 2.1, 2.3, 2.3, 1.9, 2.1, 1.8, 2.1, 2.3, 2.3, 2.1, 1.9, 
  1.3, 1.3, 1.2, 1.3, 1.4, 1.2, 0.7, 0.8, 1.0, 1.3, 0.9, 0.9, 1.0, 1.0, 1.0, 1.3, 0.8, 1.2, 0.7, 0.5, 
  1.2, 0.7, 0.7, 0.9, 0.9, 0.8, 1.1, 0.8, 0.9, 1.3, 1.2, 1.2, 1.1, 1.1, 1.0, 1.0, 0.9, 1.0, 1.2, 1.3, 
  1.5, 1.5, 1.3, 1.3, 1.6, 1.5, 1.5, 1.6, 1.7, 1.4, 1.4, 1.8, 1.8, 1.5, 1.4, 1.2, 1.5, 1.8, 1.8, 1.8, 
  1.6, 1.5, 1.5, 1.6, 1.5, 1.3, 1.4, 1.3, 1.4, 1.5, 1.5, 1.5, 1.4, 1.6, 1.5, 1.8, 1.9, 1.7, 1.7, 1.8, 
  1.6, 1.5, 1.5, 1.8, 1.9, 1.9, 1.5, 1.6, 1.6, 1.4, 1.4, 1.6, 1.5, 1.5, 1.8, 1.8, 1.9, 1.4, 1.5, 1.9, 
  1.8, 1.8, 1.4, 1.4, 1.4, 1.8, 1.6, 1.9, 1.5, 1.5, 1.7, 1.7, 1.8, 1.5, 1.6, 1.7, 1.9, 1.8, 1.8, 1.7, 
  1.7, 1.7, 1.6, 1.6, 1.4, 1.4, 1.6, 1.6, 1.9, 1.8, 1.8, 1.7, 1.7, 1.4, 1.4, 1.5, 1.8, 1.9, 1.7, 1.5, 
  1.5, 1.9, 1.9, 1.3, 1.3, 1.5, 1.9, 1.7, 1.7, 1.6, 2.0, 1.9, 2.1, 2.1, 1.8, 1.8, 1.8, 1.9, 1.5, 1.5, 
  1.4, 1.4, 1.3, 1.4, 1.6, 1.6, 1.8, 1.8, 1.8, 1.5, 1.5, 1.6, 1.6, 1.7, 1.5, 1.5, 1.5, 1.4, 1.8, 1.5, 
  1.5, 1.4, 1.5, 1.6, 1.7, 1.4, 1.4, 1.4, 1.7, 1.6, 1.8, 1.5, 1.6, 1.7, 1.7, 1.8, 1.4, 1.4, 1.5, 1.6, 
  1.3, 1.5, 1.5, 1.5, 1.8, 1.3, 1.7, 1.6, 1.5, 1.5, 1.3, 1.3, 1.7, 1.8, 1.3, 1.5, 1.5, 1.8, 1.3, 1.6, 
  1.6, 1.8, 1.7, 1.7, 1.8, 1.7, 1.5, 1.5, 1.8, 1.8, 1.4, 1.8, 1.6, 1.6, 1.8, 1.5, 1.5, 1.5, 1.4, 1.4
)
peso_radicular <- c(
  0.3, 0.3, 0.3, 0.4, 0.5, 0.6, 0.4, 0.4, 0.6, 0.6, 0.5, 0.6, 0.4, 0.3, 0.3, 0.6, 0.5, 0.4, 0.5, 0.5,
  0.3, 0.3, 0.4, 0.5, 0.5, 0.4, 0.4, 0.4, 0.3, 0.6, 0.3, 0.6, 0.4, 0.5, 0.5, 0.4, 0.6, 0.4, 0.5, 0.5,
  0.4, 0.4, 0.3, 0.4, 0.2, 0.4, 0.5, 0.5, 0.5, 0.4, 0.6, 0.3, 0.3, 0.5, 0.5, 0.5, 0.5, 0.6, 0.6, 0.5,
  0.3, 0.6, 0.7, 0.4, 0.5, 0.6, 0.3, 0.4, 0.6, 0.6, 0.6, 0.3, 0.7, 0.5, 0.4, 0.5, 0.5, 0.4, 0.6, 0.7,
  0.3, 0.4, 0.3, 0.4, 0.4, 0.3, 0.4, 0.2, 0.5, 0.5, 0.4, 0.2, 0.2, 0.5, 0.2, 0.3, 0.2, 0.5, 0.5, 0.3,
  0.4, 0.4, 0.2, 0.4, 0.4, 0.4, 0.5, 0.4, 0.2, 0.2, 0.6, 0.4, 0.4, 0.3, 0.2, 0.3, 0.2, 0.5, 0.3, 0.4,
  0.6, 0.6, 0.9, 0.7, 0.7, 0.7, 0.8, 0.8, 0.8, 1.1, 0.7, 0.9, 0.9, 0.8, 0.8, 0.9, 0.6, 0.6, 0.6, 0.8,
  0.7, 1.1, 1.1, 0.6, 0.6, 0.6, 0.8, 0.8, 0.8, 0.8, 0.8, 0.6, 0.6, 0.7, 0.8, 1.1, 0.9, 1.1, 0.9, 0.6,
  0.9, 0.6, 0.9, 0.9, 0.9, 0.7, 0.5, 0.7, 0.8, 0.7, 1.0, 0.7, 0.9, 0.9, 0.6, 0.7, 0.7, 0.7, 0.6, 0.8,
  0.8, 0.7, 0.8, 0.5, 0.7, 0.9, 0.7, 0.7, 0.8, 0.7, 0.6, 0.7, 0.6, 0.7, 0.6, 0.8, 0.8, 0.7, 0.6, 0.6,
  0.5, 0.4, 0.6, 0.6, 0.4, 0.5, 0.5, 0.5, 0.6, 0.7, 0.6, 0.6, 0.7, 0.5, 0.7, 0.9, 0.5, 0.6, 0.6, 0.5,
  0.5, 0.5, 0.7, 0.6, 0.8, 0.6, 0.5, 0.5, 0.8, 0.8, 0.8, 0.6, 0.7, 0.7, 0.9, 0.7, 0.8, 0.8, 0.5, 0.6,
  0.3, 0.4, 0.3, 0.4, 0.4, 0.4, 0.2, 0.2, 0.3, 0.3, 0.3, 0.4, 0.3, 0.3, 0.2, 0.2, 0.2, 0.2, 0.3, 0.3,
  0.3, 0.3, 0.2, 0.2, 0.2, 0.2, 0.3, 0.3, 0.5, 0.5, 0.4, 0.4, 0.4, 0.3, 0.4, 0.4, 0.3, 0.3, 0.2, 0.3,
  0.5, 0.4, 0.6, 0.5, 0.7, 0.7, 0.9, 0.6, 0.6, 0.7, 0.5, 0.8, 0.6, 0.6, 0.5, 0.8, 0.5, 0.6, 0.7, 0.6,
  0.6, 0.6, 0.6, 0.7, 0.6, 0.7, 0.6, 0.8, 0.8, 0.5, 0.6, 0.6, 0.6, 0.5, 0.7, 0.9, 0.8, 0.5, 0.8, 0.6,
  0.3, 0.4, 0.5, 0.5, 0.5, 0.4, 0.4, 0.4, 0.3, 0.3, 0.3, 0.4, 0.2, 0.2, 0.5, 0.5, 0.5, 0.7, 0.6, 0.5,
  0.3, 0.3, 0.5, 0.3, 0.2, 0.2, 0.4, 0.6, 0.7, 0.3, 0.2, 0.7, 0.5, 0.2, 0.3, 0.6, 0.7, 0.2, 0.7, 0.3,
  0.5, 0.4, 0.4, 0.4, 0.5, 0.5, 0.5, 0.6, 0.3, 0.4, 0.4, 0.3, 0.3, 0.6, 0.6, 0.4, 0.4, 0.5, 0.5, 0.3,
  0.5, 0.5, 0.5, 0.6, 0.5, 0.5, 0.4, 0.4, 0.4, 0.4, 0.3, 0.5, 0.4, 0.6, 0.7, 0.5, 0.6, 0.5, 0.4, 0.3,
  0.3, 0.4, 0.4, 0.4, 0.4, 0.3, 0.2, 0.3, 0.5, 0.5, 0.5, 0.4, 0.4, 0.5, 0.3, 0.5, 0.2, 0.3, 0.3, 0.4,
  0.4, 0.3, 0.3, 0.5, 0.4, 0.4, 0.2, 0.4, 0.4, 0.3, 0.2, 0.4, 0.4, 0.2, 0.3, 0.4, 0.3, 0.2, 0.2, 0.4,
  0.6, 0.4, 0.4, 0.5, 0.5, 0.7, 0.5, 0.7, 0.9, 0.7, 0.6, 0.7, 0.6, 0.6, 0.7, 0.4, 0.4, 0.6, 0.6, 0.7,
  0.8, 0.7, 0.7, 0.9, 0.9, 0.5, 0.5, 0.6, 0.7, 0.7, 0.8, 0.5, 0.5, 0.7, 0.7, 0.6, 0.5, 0.6, 0.5, 0.4
)

crecimiento_total <- c(
  37, 38, 35, 34, 35, 34, 36, 30, 32, 34, 33, 33, 35, 35, 36, 36, 37, 34, 35, 27, 
  34, 33, 29, 33, 30, 34, 34, 35, 34, 35, 32, 30, 34, 34, 27, 30, 37, 35, 31, 32, 
  32, 31, 31, 33, 32, 30, 31, 34, 35, 35, 31, 39, 34, 32, 34, 32, 39, 29, 32, 35, 
  36, 32, 30, 32, 28, 36, 34, 37, 30, 31, 30, 30, 31, 33, 34, 31, 29, 24, 29, 30, 
  30, 30, 33, 33, 31, 31, 28, 28, 30, 30, 29, 29, 33, 29, 34, 35, 28, 32, 30, 29, 
  29, 30, 28, 29, 34, 32, 33, 25, 29, 31, 34, 28, 28, 26, 29, 32, 34, 31, 28, 29, 
  35, 30, 33, 33, 32, 33, 34, 32, 35, 31, 34, 38, 34, 35, 26, 34, 38, 30, 35, 30, 
  26, 28, 32, 34, 29, 32, 26, 33, 33, 33, 32, 36, 32, 29, 31, 33, 31, 32, 24, 34, 
  40, 31, 38, 32, 42, 32, 35, 37, 42, 38, 36, 34, 39, 38, 38, 35, 38, 35, 38, 37, 
  33, 33, 33, 34, 31, 34, 32, 35, 34, 34, 31, 30, 30, 32, 30, 37, 35, 32, 32, 35, 
  34, 36, 32, 35, 33, 34, 34, 35, 33, 32, 31, 35, 30, 34, 35, 34, 40, 41, 35, 32, 
  36, 34, 34, 36, 34, 35, 34, 38, 38, 35, 33, 34, 31, 33, 35, 39, 39, 36, 32, 31, 
  23, 29, 20, 24, 25, 25, 22, 24, 26, 25, 21, 24, 24, 23, 25, 26, 28, 20, 23, 23, 
  26, 25, 26, 25, 26, 27, 25, 24, 29, 26, 24, 24, 25, 27, 24, 23, 24, 26, 28, 28, 
  30, 30, 27, 36, 32, 35, 30, 30, 32, 35, 33, 33, 33, 36, 34, 32, 30, 36, 33, 36, 
  33, 39, 34, 33, 38, 35, 35, 33, 31, 34, 30, 30, 33, 30, 28, 38, 28, 30, 32, 33, 
  36, 28, 36, 36, 30, 27, 28, 30, 27, 29, 28, 33, 31, 39, 31, 32, 35, 30, 30, 32, 
  30, 34, 36, 32, 34, 36, 36, 35, 33, 30, 36, 29, 32, 30, 28, 31, 31, 28, 30, 31, 
  31, 34, 32, 34, 34, 30, 33, 37, 32, 34, 31, 35, 35, 36, 36, 34, 33, 37, 33, 36, 
  33, 33, 37, 32, 36, 35, 29, 36, 32, 33, 34, 32, 33, 31, 35, 38, 37, 36, 36, 34, 
  39, 34, 36, 28, 35, 31, 34, 37, 37, 40, 35, 32, 34, 32, 38, 33, 34, 31, 34, 37, 
  26, 28, 26, 29, 30, 29, 23, 31, 28, 32, 28, 30, 29, 30, 32, 30, 32, 32, 32, 31, 
  34, 34, 36, 33, 34, 32, 31, 39, 31, 28, 28, 34, 31, 30, 27, 33, 31, 33, 34, 31, 
  33, 34, 32, 29, 34, 32, 31, 30, 35, 27, 31, 35, 27, 31, 32, 32, 28, 29, 25, 31
)

hojas_verdaderas <- c(
  4, 4, 3, 5, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 4, 5, 4, 4, 4, 4, 
  4, 3, 4, 3, 4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 3, 3, 
  3, 3, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 4, 5, 4, 4, 4, 4, 4, 3, 
  4, 3, 4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 4, 3, 3, 3, 
  3, 3, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 4, 5, 4, 4, 4, 4, 4, 3, 
  4, 3, 4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 3, 
  3, 3, 3, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 3, 3, 3, 3, 4, 
  4, 4, 4, 3, 4, 3, 3, 4, 3, 3, 3, 3, 3, 4, 3, 3, 4, 4, 4, 3, 
  3, 4, 3, 3, 3, 4, 3, 3, 4, 4, 4, 4, 4, 3, 4, 3, 4, 3, 4, 4, 
  3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 3, 
  3, 3, 3, 3, 4, 5, 4, 4, 4, 4, 4, 3, 4, 3, 4, 3, 4, 4, 3, 4, 
  4, 3, 4, 4, 3, 4, 4, 3, 4, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 3, 
  3, 3, 3, 3, 4, 5, 4, 4, 4, 4, 4, 3, 4, 3, 4, 3, 4, 4, 3, 4, 
  4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 3, 3, 3, 3, 4, 4, 3, 3, 3, 
  3, 3, 3, 3, 3, 4, 5, 4, 4, 4, 4, 4, 3, 4, 3, 4, 3, 4, 4, 3, 
  4, 4, 3, 4, 4, 3, 4, 4, 3, 4, 4, 3, 3, 3, 3, 3, 4, 4, 3, 3, 
  3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 3, 4, 4, 3, 4, 3, 3, 3, 3, 
  3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 3, 4, 4, 3, 4, 3, 4, 
  4, 3, 4, 3, 4, 4, 4, 3, 4, 4, 4, 3, 4, 3, 4, 4, 4, 4, 4, 4, 
  4, 3, 4, 4, 3, 4, 3, 4, 4, 3, 4, 3, 4, 4, 4, 3, 4, 4, 4, 3, 
  4, 3, 4, 4, 3, 4, 4, 3, 3, 4, 4, 3, 4, 4, 3, 3, 3, 4, 4, 4, 
  4, 3, 3, 4, 4, 4, 3, 3, 4, 4, 4, 3, 4, 3, 3, 3, 3, 4, 4, 4, 
  4, 4, 4, 4, 4, 3, 4, 4, 3, 4, 3, 4, 4, 3, 4, 3, 4, 4, 4, 3, 
  4, 4, 4, 3, 4, 3, 4, 4, 3, 4, 4, 3, 3, 4, 4, 3, 4, 4, 3, 3 
)

datos <- tibble(
  correlativo = correlativo,
  muestra = muestra,
  repeticion = repeticion,
  tipo_de_tratamiento = tipo_de_tratamiento,
  peso_foliar = peso_foliar,
  peso_radicular = peso_radicular,
  crecimiento_total = crecimiento_total
)

glimpse(datos)


# ==============================================================================
# 2. PREPARACIÓN DE DATOS
# ==============================================================================

# Convertir tipo_de_tratamiento a factor
datos <- datos %>%
  mutate(
    tipo_de_tratamiento = factor(tipo_de_tratamiento,
                                 levels = c(1, 2, 3, 4, 5, 6),
                                 labels = paste("Tratamiento", 1:6))
  )

# Verificar estructura
glimpse(datos)

# ==============================================================================
# 3. VERIFICACIÓN DE SUPUESTOS MULTIVARIANTES
# ==============================================================================

# Seleccionar variables de respuesta
variables_respuesta <- datos %>%
  dplyr::select(peso_foliar, peso_radicular, crecimiento_total)

# ------------------------------------------------------------------------------
# 3.1 Normalidad Multivariante
# ------------------------------------------------------------------------------

# con paquete MVN

# Prueba de Mardia (asimetría y curtosis multivariante)
mvn_mardia <- mvn(variables_respuesta, mvn_test = "mardia")
mvn_mardia

# Prueba de Henze-Zirkler
mvn_hz <- mvn(variables_respuesta, mvn_test = "hz")
mvn_hz

# Prueba de Royston
mvn_royston <- mvn(variables_respuesta, mvn_test = "royston")
mvn_royston

# Prueba de Doornik-Hansen
mvn_dh <- mvn(variables_respuesta, mvn_test = "doornik_hansen")
mvn_dh

# Gráfico Q-Q multivariante
multivariate_diagnostic_plot(
  variables_respuesta,
  type = c("qq"),
  tol = 1e-25,
  use_population = TRUE
)

multivariate_diagnostic_plot(
  variables_respuesta,
  type = c("persp"),
  tol = 1e-25,
  use_population = TRUE
)

multivariate_diagnostic_plot(
  variables_respuesta,
  type = c("contour"),
  tol = 1e-25,
  use_population = TRUE
)

# con rstatix (Prueba multivariante de Shapiro-Wilk)

mshapiro_test(variables_respuesta)

# ------------------------------------------------------------------------------
# 3.2 Homocedasticidad Multivariante (Homogeneidad de matrices de covarianza)
# ------------------------------------------------------------------------------

# Prueba M de Box
box_m <- boxM(variables_respuesta, datos$tipo_de_tratamiento)
box_m

biotools::boxM(variables_respuesta, datos$tipo_de_tratamiento)
heplots::boxM(variables_respuesta, datos$tipo_de_tratamiento)

# ------------------------------------------------------------------------------
# 3.3 Independencia de las observaciones
# ------------------------------------------------------------------------------

variables_respuesta %>%
  rstatix::cor_test(method = "pearson") %>%
  filter(var1 < var2)

variables_respuesta %>%
  rstatix::cor_test(method = "spearman") %>%
  filter(var1 < var2)

# ==============================================================================
# 4. IMPLEMENTACIÓN DEL ANÁLISIS DE RESPUESTA MÚLTIPLE NO PARAMÉTRICO
# ==============================================================================

# ------------------------------------------------------------------------------
# 4.1 Paquete npmv
# ------------------------------------------------------------------------------

# Realizar el análisis no paramétrico multivariante

nonpartest(peso_foliar | peso_radicular | crecimiento_total ~ factor(tipo_de_tratamiento), 
           data = datos, permreps = 1000)

ssnonpartest(peso_foliar | peso_radicular | crecimiento_total ~ factor(tipo_de_tratamiento), 
             data = datos, 
             test = c(0,0,0,1),
             alpha = 0.05,
             factors.and.variables = TRUE)

# ==============================================================================
# 5. PERMANOVA CON EL PAQUETE VEGAN
# ==============================================================================

# Crear matriz de variables respuesta
Y <- datos %>%
  dplyr::select(peso_foliar, peso_radicular, crecimiento_total)

# 1. PRIMERO: Verificar el supuesto de homogeneidad de dispersiones
dist_matriz <- vegdist(Y, method = "euclidean")
betadisper_resultado <- betadisper(dist_matriz, datos$tipo_de_tratamiento)
permutest(betadisper_resultado)

# Interpretación:
# p > 0.05 → Dispersiones homogéneas (supuesto cumplido) → Proceder con PERMANOVA
# p < 0.05 → Dispersiones heterogéneas (supuesto NO cumplido) → Interpretar con cautela

# 2. DESPUÉS: Realizar PERMANOVA
permanova_resultado <- adonis2(Y ~ tipo_de_tratamiento, 
                               data = datos, 
                               method = "euclidean", 
                               permutations = 999)
permanova_resultado

# ==============================================================================
# FIN DEL SCRIPT
# ==============================================================================